아이템 3.볼륨 마운트
=========================
## ⭕ 파일 복사
### ◉ 볼륨과 마운트
볼륨이란 스토리지의 한 영역을 분할한 것을 말한다. 간단히 말하면 하드디스크나 SSD를 분할한 하나의 영역이다.

마운트는 '연결하다'라는 의미 그대로 대상을 연결해 운영체제 또는 소프트웨어의 관리하에 두는 일을 말한다.

컨테이너 속에 있는 데이터는 컨테이너가 삭제되거나 소프트웨어 업그레이드 등의 이유로 언젠가는 삭제되기 때문에 컨테이너 외부에 데이터를 저장하는 것이 필요하고 이를 데이터 퍼시스턴시라고 부른다.

---

## ⭕ 스토리지 마운트의 종류
### ◉ 볼륨 마운트
볼륨 마운트는 도커 엔진이 관리하는 영역 내에 만들어진 볼륨을 컨테이너에 디스크 형태로 마운트 한다.

### ◉ 바인드 마운트
바인드 마운트는 도커가 설치된 컴퓨터의 문서 폴더 또는 바탕화면 폴더 등 도커 엔진에서 관리하지 않는 영ㅇ역의 기존 디렉터리를 컨테이너에 마운트하는 방식이다.

### ◉ 두 가지 마운트 방식의 차이점
| 항목 | 볼륨 마운트 | 바인드 마운트 |
|----|------------|------------|
| 스토리지 영역 | 볼륨 | 디렉터리 또는 파일 |
| 물리적 위치 | 도커 엔진의 관리 영역 | 어디든지 가능 |
| 마운트 절차 | 볼륨을 생성한 후 마운트 | 기존 파일 또는 폴더를 마운트 |
| 내용 편집 | 도커 컨테이너를 통해서 | 일반적인 파일과 같이 |
| 백업 | 절차가 복잡함 | 일반적인 파일과 같이 |

#### ✦ 임시 메모리(tmpfs) 마운트
임시 메모리 마운트는 디스크가 아닌 주 메모리 영역을 마운트 한다. 디스크보다 훨씬 빠른 속도로 읽고 쓰기가 가능하기 떄문에 접근 속도를 높일 목적으로 사용하지만 도커 엔진이 정지되거나 호스트가 재부팅하면 소멸한다.

---

## ⭕ 스토리지 영역을 마운트하는 커맨드
어느 마운트 방식을 사용하든 스토리지 마운트는 run 커맨드의 옵션 형태로 지정한다.

### ◉ 스토리지를 마운트하는 절차
스토리지 영역을 생성 -> 컨테이너를 생성 및 마운트

### ◉ 스토리지 영역을 만드는 방법
볼륨 생성
> docker volume create [옵션] 볼륨이름

볼륨 삭제
> docker volume rm 볼륨이름

#### ✦ 주요 하위 커맨드
| 커맨드 | 내용 | 생략형 | 주요 옵션 |
|------|------|-------|---------|
| create | 볼륨을 생성 | X | 거의 사용하지 않음 |
| inspect | 볼륨의 상세 정보를 출력 | X | 거의 사용하지 않음 |
| ls | 볼륨 목록을 출력 | X | 거의 사용하지 않음 |
| prune | 현재 마운트되지 않은 볼륨을 모두 삭제 | X | 거의 사용하지 않음 |
| rm | 지정한 볼륨을 삭제 | X | 거의 사용하지 않음 |

### ◉ 스토리지를 마운트하는 커맨드
-v 옵션 뒤에 '스토리지 실제 경로' 또는 '볼륨 이름', '컨테이너 마운트 경로'순서대로 기재한다. 이들 경로는 콜론(:)을 사용해 ㄱ ㅜ분한다.

바인드 마운트 커맨드
> docker run -v [스토리지 실제 경로]:[컨테이너 마운트 경로] [이미지 이름]

볼륨 마운트 커맨드
> docker run -v [볼륨 이름]:[컨테이너 마운트 경로] [이미지 이름]

## ⭕ [실습] 바인드 마운트해보기
### ◉ 실습 내용
폴더 생성 -> 아파치 컨테이너 생성 -> 초기 화면 진입 -> index.html 파일을 배치 -> 확인

### ◉ 생성할 컨테이너 정보
| 항목 | 값 |
|----|----|
| 컨테이너 이름 | apa000ex20 |
| 이미지 이름 | httpd |
| 포트 설정 | 8090 |

### ◉ -v 옵션의 설정 값
| 항목                      | 값                                                                    |
|-------------------------|----------------------------------------------------------------------|
| 컨테이너 마운드 경로(마운트 대상)     | /usr/local/apache2/htdocs                                            |
| 실제 폴더 / 디렉터리 이름(마운트 원본) | apa_folder                                                           |
| 실제 마운트 원본 경로 | /Users/hhnho/workspace/docker-kubernetes/src/main/resources/example/apa_folder |

1. 마운트 원본이 될 폴더/디렉터리 만들기

2. run 커맨드로 아파치 컨테이너 실행
> docker run --name apa000ex20 -d -p 8090:80 -v /Users/hhnho/workspace/docker-kubernetes/src/main/resources/example/apa_folder:/usr/local/apache2/htdocs httpd

3. 웹 브라우저를 통해 아파치에 접근해 초기 화면 확인
4. 마운트된 폴더/디렉터리에 index.html 파일을 배치
5. index.html 파일이 변경됐는지 확인
6. 뒷정리

---

## ⭕ [실습] 응용편 - 볼륨 마운트해보기
볼륨 생성 -> 아파치 컨테이너 생성 -> 확인

### ◉ 생성할 컨테이너 정보
| 항목 | 값 |
|----|----|
| 컨테이너 이름 | apa000ex21 |
| 이미지 이름 | httpd |
| 볼륨 이름 | apa000val1 |
| 포트 설정 | 8091 |

1. 마운트할 볼륨 생성
> docker volume create apa000val1
2. run 커맨드로 아파치 컨테이너 실행
> docker run --name apa000ex21 -d -p 8091:80 -v apa000val1:/usr/local/apache2/htdocs httpd
3. volume inspect 커맨드로 볼륨의 상세 정보 확인
> docker volume inspect apa000val1
4. 볼륨 마운트된 폴더/디렉터리에 index.html 파일을 배치
> docker cp /Users/hhnho/workspace/docker-kubernetes/src/main/resources/example/index.html apa000ex21:/usr/local/apache2/htdocs
5. 웹 브라우저를 통해 아파치에 접근해 화면 확인
6. 다른 컨테이너에 해당 볼륨을 마운트
> docker run --name apa000ex22 -d -p 8092:80 -v apa000val1:/usr/local/apache2/htdocs httpd
7. 웹 브라우저를 통해 새롭게 만든 컨테이너 아파치에 접근해 화면 확인
8. 첫번째 컨테이너에 연결된 볼륨에 index.html 파일을 변경하고 2개 컨테이너 모두 확인
> docker cp /Users/hhnho/workspace/docker-kubernetes/src/main/resources/example/index2.html apa000ex21:/usr/local/apache2/htdocs/index.html
9. 첫번째 컨테이너만 삭제 후 두번째 컨테이너에서 정상적으로 화면이 보이는지 확인
10. 정리

#####❗️사용 중이 볼륨을 삭제 시에는 에러가 발생한다.
#####❗️이미 실행 중인 컨테이너에 동적으로 볼륨을 추가할 수 없다. 컨테이너를 삭제하고 다시 생성해야 한다.

#### ✦ 볼륨 마운트를 확인
볼륨 내부는 컨테이너를 거치지 않고는 확인이 어렵다.
1. 컨테이너 내부 접속
> docker exec -it apa000ex22 /bin/bash
2. 볼륨 내부로 이동
> cd /usr/local/apache2/htdocs
3. 볼륨 내부의 파일 확인
> ls
4. 컨테이너를 빠져나오기
> exit

#### ✦ 볼륨 백업
볼륨 자체를 복사할 수 없으므로 컨테이너를 연결해 볼륨의 내용을 압축해 저장해야 한다.
임시 컨테이너를 사용하여 백업(컨테이너를 생성하고 볼륨을 백업한 후 컨테이너를 바로 삭제)
> docker run --rm -v 볼륨명:/source -v 백업_저장_폴더명:/target busybox tar cvzf /target/백업파일명.tar.gz -C /source .
> docker run --rm -v apa000val1:/source -v /Users/hhnho/workspace/docker-kubernetes/src/main/resources/example/backup:/target busybox tar cvzf /target/apa000val1.tar.gz -C /source .

:/source는 :/target은 볼륨을 마운트한 컨테이너의 디렉터리를 가리키며 내부에서 사용하기 위한 디렉토리 경로 이름이다. 

볼륨에 있는 파일을 호스트로 복사하는 방식은 안되는 걸까? ⭕️ 가능하다. 컨테이너가 삭제되고 볼륨만 있는 경우에 대한 백업을 말하는 것일까?

#### ✦ busybox 이미지
busybox는 리눅스의 기본 명령어를 모아놓은 이미지로 컨테이너를 생성하면 리눅스의 기본 명령어를 사용할 수 있다.

주요 특징
* 경량화: 크기가 작고 리소스 소모가 적어 제한된 환경에서 사용 가능.
* 다양한 유틸리티 통합: ls, cp, tar 등 리눅스 명령어를 단일 바이너리로 제공.
* 임베디드 및 컨테이너 최적화: Docker 및 임베디드 시스템에서 최적화된 도구로 활용.
* 단일 실행 파일: 모든 유틸리티를 하나의 바이너리로 통합해 간편한 배포 가능.
* 네트워크 도구 지원: wget, ping 등 기본 네트워크 유틸리티 포함.
